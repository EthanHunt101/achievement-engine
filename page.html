<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Achievement Engine - Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="theme-picker" id="themePicker">
                <button type="button" class="theme-picker-btn" id="themePickerBtn" aria-label="Choose color scheme" title="Choose color scheme"></button>
                <div class="theme-picker-dropdown" id="themePickerDropdown">
                    <button type="button" class="theme-option active" data-theme="default">
                        <span class="theme-option-swatch" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></span>
                        Default
                    </button>
                    <button type="button" class="theme-option" data-theme="ocean">
                        <span class="theme-option-swatch" style="background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);"></span>
                        Ocean
                    </button>
                    <button type="button" class="theme-option" data-theme="forest">
                        <span class="theme-option-swatch" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);"></span>
                        Forest
                    </button>
                    <button type="button" class="theme-option" data-theme="coral">
                        <span class="theme-option-swatch" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);"></span>
                        Coral
                    </button>
                    <button type="button" class="theme-option" data-theme="slate">
                        <span class="theme-option-swatch" style="background: linear-gradient(135deg, #475569 0%, #1e293b 100%);"></span>
                        Slate
                    </button>
                </div>
            </div>
            <div class="nav-links">
                <a href="dlc.html">DLC Checklist</a>
            </div>
            <h1>üéÆ Achievement Engine</h1>
            <p>Main Dashboard</p>
        </header>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Games Started</h3>
                <div class="value" id="totalGames">-</div>
            </div>
            <div class="stat-card">
                <h3>Games Completed</h3>
                <div class="value" id="completedGames">-</div>
                <div class="subvalue" id="completionRate">-</div>
            </div>
            <div class="stat-card">
                <h3>Gamerscore</h3>
                <div class="value" id="gsEarned">-</div>
                <div class="subvalue" id="gsCompletion">-</div>
            </div>
            <div class="stat-card">
                <h3>TA Score</h3>
                <div class="value" id="taEarned">-</div>
                <div class="subvalue" id="taCompletion">-</div>
            </div>
            <div class="stat-card">
                <h3>Overall TA Ratio</h3>
                <div class="value" id="taRatioEarned">-</div>
                <div class="subvalue" id="taRatioPossible">-</div>
            </div>
        </div>

        <div class="pane" id="pane-completion">
            <button type="button" class="pane-header" aria-expanded="false" aria-controls="pane-completion-body">
                <span class="pane-title">Completion Distribution</span>
                <span class="pane-chevron" aria-hidden="true">‚ñ∂</span>
            </button>
            <div class="pane-body" id="pane-completion-body">
                <div class="pane-body-inner">
                    <div class="completion-buckets" id="completionBuckets"></div>
                </div>
            </div>
        </div>

        <div class="pane" id="pane-recommendations">
            <button type="button" class="pane-header" aria-expanded="false" aria-controls="pane-recommendations-body">
                <span class="pane-title">Finish Next Recommendations</span>
                <span class="pane-chevron" aria-hidden="true">‚ñ∂</span>
            </button>
            <div class="pane-body" id="pane-recommendations-body">
                <div class="pane-body-inner">
                    <div class="recommendations-list" id="recommendationsList">
                        <div class="loading">Loading recommendations...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="pane" id="pane-blocked">
            <button type="button" class="pane-header" aria-expanded="false" aria-controls="pane-blocked-body">
                <span class="pane-title">Games with Unachievable Achievements</span>
                <span class="pane-chevron" aria-hidden="true">‚ñ∂</span>
            </button>
            <div class="pane-body" id="pane-blocked-body">
                <div class="pane-body-inner">
                    <div id="blockedGames">
                        <div class="loading">Loading blocked games...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="pane" id="pane-dlc-only">
            <button type="button" class="pane-header" aria-expanded="false" aria-controls="pane-dlc-only-body">
                <span class="pane-title">Games with Only DLC Remaining</span>
                <span class="pane-chevron" aria-hidden="true">‚ñ∂</span>
            </button>
            <div class="pane-body" id="pane-dlc-only-body">
                <div class="pane-body-inner">
                    <div id="dlcOnlyGames">
                        <div class="loading">Loading DLC-only games...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = null;

        async function loadData() {
            try {
                const response = await fetch('main_stats.json');
                if (!response.ok) {
                    throw new Error('Failed to load data');
                }
                allData = await response.json();
                render();
            } catch (error) {
                document.getElementById('statsGrid').innerHTML = 
                    '<div class="error">Error loading data. Make sure main_stats.json exists.<br><br>Run: python rank_next.py --export-main-json main_stats.json</div>';
                console.error('Error:', error);
            }
        }

        function render() {
            if (!allData) return;

            updateStats();
            renderCompletionBuckets();
            renderRecommendations();
            renderBlockedGames();
            renderDlcOnlyGames();
        }

        function updateStats() {
            const profile = allData.profile_summary;
            
            document.getElementById('totalGames').textContent = profile.total_games.toLocaleString();
            document.getElementById('completedGames').textContent = profile.completed_games.toLocaleString();
            const completionRate = profile.total_games > 0 
                ? ((profile.completed_games / profile.total_games) * 100).toFixed(1) + '%'
                : '0%';
            document.getElementById('completionRate').textContent = completionRate + ' completion rate';

            document.getElementById('gsEarned').textContent = profile.total_gs_earned.toLocaleString();
            document.getElementById('gsCompletion').textContent = 
                profile.total_gs_earned.toLocaleString() + ' / ' + profile.total_gs_possible.toLocaleString() + 
                ' GS (' + profile.gs_completion_pct.toFixed(2) + '%)';
            
            // Note: These totals are based on what's in your CSV export files.
            // If your actual totals are higher, your CSV export may be incomplete.

            document.getElementById('taEarned').textContent = profile.total_ta_earned.toLocaleString();
            document.getElementById('taCompletion').textContent = 
                profile.total_ta_earned.toLocaleString() + ' / ' + profile.total_ta_possible.toLocaleString() + 
                ' TA (' + profile.ta_completion_pct.toFixed(2) + '%)';

            const taRatioEarned = profile.overall_ta_ratio_earned;
            const taRatioPossible = profile.overall_ta_ratio_possible;
            document.getElementById('taRatioEarned').textContent = taRatioEarned ? taRatioEarned.toFixed(2) : 'N/A';
            document.getElementById('taRatioPossible').textContent = taRatioPossible ? 'Possible: ' + taRatioPossible.toFixed(2) : '';
        }

        function renderCompletionBuckets() {
            const buckets = allData.completion_buckets || [];
            const container = document.getElementById('completionBuckets');
            const totalGames = allData.profile_summary.started_games;

            if (buckets.length === 0) {
                container.innerHTML = '<div class="empty-state">No completion data available</div>';
                return;
            }

            let html = '';
            for (const bucket of buckets) {
                const width = totalGames > 0 ? (bucket.count / totalGames * 100) : 0;
                html += `
                    <div class="bucket-card">
                        <div class="bucket-label">${bucket.label}</div>
                        <div class="bucket-count">${bucket.count}</div>
                        <div class="bucket-percentage">${bucket.percentage.toFixed(1)}%</div>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${width}%"></div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function renderRecommendations() {
            const recommendations = allData.recommendations || [];
            const container = document.getElementById('recommendationsList');

            if (recommendations.length === 0) {
                container.innerHTML = '<div class="empty-state">No recommendations available</div>';
                return;
            }

            let html = '';
            for (const rec of recommendations) {
                const flags = [];
                if (rec.unach_ach > 0) {
                    flags.push(`<span class="flag warning">‚ö† ${rec.unach_ach} unachievable</span>`);
                }
                if (rec.dlc_remaining > 0) {
                    flags.push(`<span class="flag info">DLC: ${rec.dlc_remaining} remaining</span>`);
                }

                const ratioStr = rec.avg_locked_ratio ? rec.avg_locked_ratio.toFixed(2) : 'N/A';
                html += `
                    <div class="recommendation-item">
                        <div class="recommendation-header">
                            <div class="recommendation-title">${escapeHtml(rec.game)}</div>
                        </div>
                        <div class="recommendation-stats">
                            <span>üìä ${rec.completion.toFixed(1)}% Complete</span>
                            <span>‚≠ê ${rec.remaining_gs.toLocaleString()} GS remaining</span>
                            <span>üéØ ${rec.remaining_ach} achievements remaining</span>
                            <span>üìà Avg Ratio: ${ratioStr}</span>
                        </div>
                        ${flags.length > 0 ? `<div class="flags">${flags.join('')}</div>` : ''}
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function renderBlockedGames() {
            const blocked = allData.blocked_games || {};
            const games = blocked.games || [];
            const container = document.getElementById('blockedGames');

            if (games.length === 0) {
                container.innerHTML = '<div class="empty-state">No blocked games</div>';
                return;
            }

            let html = `
                <div style="margin-bottom: 15px; padding: 15px; background: #fff3cd; border-radius: 6px;">
                    <strong>Total unachievable achievements:</strong> ${blocked.total_unach_count.toLocaleString()}<br>
                    <strong>Total GS lost:</strong> ${blocked.total_unach_gs.toLocaleString()}
                </div>
                <div class="blocked-list">
            `;

            for (const game of games) {
                const className = game.fully_blocked ? 'fully-blocked' : 'partially-blocked';
                const status = game.fully_blocked ? 'fully blocked' : `${game.unach_count} of ${game.total_locked} locked`;
                html += `
                    <div class="blocked-item ${className}">
                        <div>
                            <strong>${escapeHtml(game.game)}</strong>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                ${game.unach_count} unachievable (${status}) - ${game.unach_gs.toLocaleString()} GS
                            </div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function renderDlcOnlyGames() {
            const games = allData.dlc_only_games || [];
            const container = document.getElementById('dlcOnlyGames');

            if (games.length === 0) {
                container.innerHTML = '<div class="empty-state">No games with only DLC remaining</div>';
                return;
            }

            let html = '<div class="dlc-only-list">';
            for (const game of games) {
                html += `
                    <div class="dlc-only-item">
                        <strong>${escapeHtml(game.game)}</strong>
                        <span>${game.dlc_achievements_remaining} DLC achievements remaining</span>
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.querySelectorAll('.pane-header').forEach(btn => {
            btn.addEventListener('click', () => {
                const pane = btn.closest('.pane');
                const isOpen = pane.classList.toggle('open');
                btn.setAttribute('aria-expanded', isOpen);
            });
        });

        (function initTheme() {
            const KEY = 'achievement-engine-theme';
            const picker = document.getElementById('themePicker');
            const btn = document.getElementById('themePickerBtn');
            const dropdown = document.getElementById('themePickerDropdown');

            function applyTheme(theme) {
                document.body.classList.remove('theme-ocean', 'theme-forest', 'theme-coral', 'theme-slate');
                if (theme && theme !== 'default') document.body.classList.add('theme-' + theme);
                try { localStorage.setItem(KEY, theme || 'default'); } catch (e) {}
                dropdown.querySelectorAll('.theme-option').forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.theme === (theme || 'default'));
                });
            }

            const saved = (function() { try { return localStorage.getItem(KEY); } catch (e) { return null; } })();
            if (saved) applyTheme(saved);

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                picker.classList.toggle('open');
            });

            dropdown.querySelectorAll('.theme-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    applyTheme(opt.dataset.theme);
                    picker.classList.remove('open');
                });
            });

            dropdown.addEventListener('click', e => e.stopPropagation());
            document.addEventListener('click', () => picker.classList.remove('open'));
        })();

        loadData();
    </script>
</body>
</html>
