<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Achievement Engine - DLC Checklist</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="theme-picker" id="themePicker">
                <button type="button" class="theme-picker-btn" id="themePickerBtn" aria-label="Choose color scheme" title="Choose color scheme"></button>
                <div class="theme-picker-dropdown" id="themePickerDropdown">
                    <button type="button" class="theme-option active" data-theme="default">
                        <span class="theme-option-swatch" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></span>
                        Default
                    </button>
                    <button type="button" class="theme-option" data-theme="ocean">
                        <span class="theme-option-swatch" style="background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);"></span>
                        Ocean
                    </button>
                    <button type="button" class="theme-option" data-theme="forest">
                        <span class="theme-option-swatch" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);"></span>
                        Forest
                    </button>
                    <button type="button" class="theme-option" data-theme="coral">
                        <span class="theme-option-swatch" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);"></span>
                        Coral
                    </button>
                    <button type="button" class="theme-option" data-theme="slate">
                        <span class="theme-option-swatch" style="background: linear-gradient(135deg, #475569 0%, #1e293b 100%);"></span>
                        Slate
                    </button>
                </div>
            </div>
            <div class="nav-links">
                <a href="page.html">Main Dashboard</a>
            </div>
            <h1>üéÆ Achievement Engine</h1>
            <p>DLC Completion Checklist</p>
        </header>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Total DLCs</h3>
                <div class="value" id="totalDlcs">-</div>
            </div>
            <div class="stat-card">
                <h3>Completed</h3>
                <div class="value" id="completedDlcs">-</div>
                <div class="subvalue" id="completedPct">-</div>
            </div>
            <div class="stat-card">
                <h3>DLC Achievements</h3>
                <div class="value" id="totalAch">-</div>
                <div class="subvalue" id="completedAch">-</div>
            </div>
            <div class="stat-card">
                <h3>DLC Gamerscore</h3>
                <div class="value" id="totalGs">-</div>
                <div class="subvalue" id="completedGs">-</div>
            </div>
            <div class="stat-card">
                <h3>DLC TA Score</h3>
                <div class="value" id="totalTa">-</div>
                <div class="subvalue" id="completedTa">-</div>
            </div>
            <div class="stat-card">
                <h3>Overall TA Ratio</h3>
                <div class="value" id="overallRatio">-</div>
                <div class="subvalue" id="earnedRatio">-</div>
            </div>
        </div>

        <div class="controls">
            <label for="searchInput">Search:</label>
            <input type="text" id="searchInput" placeholder="Search games or DLCs...">
            
            <label for="filterSelect">Filter:</label>
            <select id="filterSelect">
                <option value="all">All DLCs</option>
                <option value="completed">Completed Only</option>
                <option value="incomplete">Incomplete Only</option>
            </select>
        </div>

        <div class="filter-info hidden" id="filterInfo"></div>

        <div class="content" id="content">
            <div class="loading">Loading DLC data...</div>
        </div>
    </div>

    <script>
        let allData = null;
        let filteredData = null;

        // Load JSON data
        async function loadData() {
            try {
                const response = await fetch('dlc_data.json');
                if (!response.ok) {
                    throw new Error('Failed to load data');
                }
                allData = await response.json();
                filteredData = allData;
                render();
            } catch (error) {
                document.getElementById('content').innerHTML = 
                    '<div class="error">Error loading data. Make sure dlc_data.json exists.<br><br>Run: python rank_next.py --export-json dlc_data.json</div>';
                console.error('Error:', error);
            }
        }

        function updateStats() {
            if (!allData) return;

            const summary = allData.summary;
            const overall = allData.overall_stats || {};
            
            document.getElementById('totalDlcs').textContent = summary.total_dlcs.toLocaleString();
            document.getElementById('completedDlcs').textContent = summary.completed_dlcs.toLocaleString();
            const completedPct = summary.total_dlcs > 0 
                ? ((summary.completed_dlcs / summary.total_dlcs) * 100).toFixed(1) + '%'
                : '0%';
            document.getElementById('completedPct').textContent = completedPct;

            document.getElementById('totalAch').textContent = summary.total_dlc_achievements.toLocaleString();
            document.getElementById('completedAch').textContent = summary.completed_dlc_achievements.toLocaleString() + ' completed';

            document.getElementById('totalGs').textContent = summary.total_dlc_gamerscore.toLocaleString();
            document.getElementById('completedGs').textContent = summary.completed_dlc_gamerscore.toLocaleString() + ' GS completed';

            document.getElementById('totalTa').textContent = (summary.total_dlc_tascore || 0).toLocaleString();
            document.getElementById('completedTa').textContent = (summary.completed_dlc_tascore || 0).toLocaleString() + ' TA completed';

            const overallRatio = overall.avg_overall_ratio;
            const earnedRatio = overall.avg_earned_ratio;
            document.getElementById('overallRatio').textContent = overallRatio ? overallRatio.toFixed(2) : 'N/A';
            document.getElementById('earnedRatio').textContent = earnedRatio ? 'Earned: ' + earnedRatio.toFixed(2) : '';
        }

        function render() {
            if (!filteredData) return;

            updateStats();

            const content = document.getElementById('content');
            const games = filteredData.games || {};

            if (Object.keys(games).length === 0) {
                content.innerHTML = '<div class="no-data">No DLC data available</div>';
                return;
            }

            let html = '';
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filter = document.getElementById('filterSelect').value;

            let visibleCount = 0;
            let totalCount = 0;

            for (const [gameName, dlcs] of Object.entries(games)) {
                if (!Array.isArray(dlcs) || dlcs.length === 0) continue;

                // Filter DLCs
                let visibleDlcs = dlcs.filter(dlc => {
                    totalCount++;
                    const matchesSearch = !searchTerm || 
                        gameName.toLowerCase().includes(searchTerm) ||
                        dlc.dlc_name.toLowerCase().includes(searchTerm);
                    
                    if (!matchesSearch) return false;

                    if (filter === 'completed') {
                        return dlc.is_completed;
                    } else if (filter === 'incomplete') {
                        return !dlc.is_completed;
                    }
                    return true;
                });

                if (visibleDlcs.length === 0) continue;

                visibleCount += visibleDlcs.length;

                const completedCount = visibleDlcs.filter(d => d.is_completed).length;
                const gameId = gameName.replace(/[^a-zA-Z0-9]/g, '_');
                const gameStats = (allData.game_stats || {})[gameName] || {};
                const gameTa = gameStats.total_ta || 0;
                const gameEarnedTa = gameStats.earned_ta || 0;
                const gameTotalGs = gameStats.total_gs || 0;
                const gameEarnedGs = gameStats.earned_gs || 0;
                const gameEarnedRatio = gameStats.avg_earned_ratio;
                const gameOverallRatio = gameStats.avg_overall_ratio;

                html += `
                    <div class="game-section" data-game-id="${gameId}">
                        <div class="game-header" onclick="toggleGame('${gameId}')">
                            <span>
                                <strong>${escapeHtml(gameName)}</strong>
                                ${gameTotalGs > 0 ? `<span style="font-size: 0.85em; margin-left: 10px; opacity: 0.9;">‚≠ê ${gameEarnedGs.toLocaleString()}/${gameTotalGs.toLocaleString()} GS</span>` : ''}
                                ${gameTa > 0 ? `<span style="font-size: 0.85em; margin-left: 10px; opacity: 0.9;">üéñÔ∏è ${gameEarnedTa.toLocaleString()}/${gameTa.toLocaleString()} TA</span>` : ''}
                                ${gameEarnedRatio ? `<span style="font-size: 0.85em; margin-left: 10px; opacity: 0.9;">üìä Earned Ratio: ${gameEarnedRatio.toFixed(2)}</span>` : ''}
                                ${gameOverallRatio ? `<span style="font-size: 0.85em; margin-left: 10px; opacity: 0.7;">(Overall: ${gameOverallRatio.toFixed(2)})</span>` : ''}
                            </span>
                            <span>
                                <span class="count">${completedCount}/${visibleDlcs.length} completed</span>
                                <span class="toggle">‚ñº</span>
                            </span>
                        </div>
                        <div class="dlc-list" id="dlc-list-${gameId}">
                `;

                for (const dlc of visibleDlcs) {
                    const progressPct = dlc.total_gs > 0 ? (dlc.earned_gs / dlc.total_gs * 100) : 0;
                    const avgRatio = dlc.avg_overall_ratio;
                    const ratioDisplay = avgRatio ? avgRatio.toFixed(2) : 'N/A';
                    html += `
                        <div class="dlc-item ${dlc.is_completed ? 'completed' : ''}">
                            <input type="checkbox" class="dlc-checkbox" ${dlc.is_completed ? 'checked' : ''} disabled>
                            <div class="dlc-info">
                                <div class="dlc-name">${escapeHtml(dlc.dlc_name)}</div>
                                <div class="dlc-stats">
                                    <span>üìä ${dlc.earned_ach}/${dlc.total_ach} achievements</span>
                                    <span>‚≠ê ${dlc.earned_gs}/${dlc.total_gs} GS</span>
                                    <span>üéñÔ∏è ${(dlc.earned_ta || 0).toLocaleString()}/${(dlc.total_ta || 0).toLocaleString()} TA</span>
                                    <span>üìà ${dlc.completion_pct.toFixed(1)}%</span>
                                    <span>üìä Ratio: ${ratioDisplay}</span>
                                    ${dlc.remaining_ach > 0 ? `<span>üéØ ${dlc.remaining_ach} left</span>` : ''}
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPct}%"></div>
                            </div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;

            // Update filter info
            const filterInfo = document.getElementById('filterInfo');
            if (searchTerm || filter !== 'all') {
                filterInfo.textContent = `Showing ${visibleCount} of ${totalCount} DLCs`;
                filterInfo.classList.remove('hidden');
            } else {
                filterInfo.classList.add('hidden');
            }
        }

        function toggleGame(gameId) {
            const section = document.querySelector(`[data-game-id="${gameId}"]`);
            if (section) {
                section.classList.toggle('expanded');
                const toggle = section.querySelector('.toggle');
                if (toggle) {
                    toggle.textContent = section.classList.contains('expanded') ? '‚ñ≤' : '‚ñº';
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', () => {
            render();
        });

        document.getElementById('filterSelect').addEventListener('change', () => {
            render();
        });

        (function initTheme() {
            const KEY = 'achievement-engine-theme';
            const picker = document.getElementById('themePicker');
            const btn = document.getElementById('themePickerBtn');
            const dropdown = document.getElementById('themePickerDropdown');

            function applyTheme(theme) {
                document.body.classList.remove('theme-ocean', 'theme-forest', 'theme-coral', 'theme-slate');
                if (theme && theme !== 'default') document.body.classList.add('theme-' + theme);
                try { localStorage.setItem(KEY, theme || 'default'); } catch (e) {}
                dropdown.querySelectorAll('.theme-option').forEach(opt => {
                    opt.classList.toggle('active', opt.dataset.theme === (theme || 'default'));
                });
            }

            const saved = (function() { try { return localStorage.getItem(KEY); } catch (e) { return null; } })();
            if (saved) applyTheme(saved);

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                picker.classList.toggle('open');
            });

            dropdown.querySelectorAll('.theme-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    applyTheme(opt.dataset.theme);
                    picker.classList.remove('open');
                });
            });

            dropdown.addEventListener('click', e => e.stopPropagation());
            document.addEventListener('click', () => picker.classList.remove('open'));
        })();

        // Initialize
        loadData();
    </script>
</body>
</html>
